name: Build and Deploy Eleventy Site to GitHub Pages

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
      
      - name: Get pathPrefix from repository
        id: get-prefix
        run: |
          # Try to get prefix from package.json or use repository name
          if [ -n "${{ vars.PATH_PREFIX }}" ]; then
            PREFIX="${{ vars.PATH_PREFIX }}"
          else
            REPO_NAME="${{ github.repository }}"
            REPO_NAME="${REPO_NAME#*/}"
            PREFIX="/${REPO_NAME}/"
          fi
          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT
          echo "Using path prefix: $PREFIX"
        
      - name: Build site
        run: npm run build
        env:
          ELEVENTY_ENV: production
          PREFIX: ${{ steps.get-prefix.outputs.prefix }}
          
      - name: Deploy to GitHub Pages
        run: |
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            # Remove existing files (but keep .git and .github)
            find . -maxdepth 1 -not -name '.git' -not -name '.github' -not -name '_site' -not -name '.' -exec rm -rf {} +
            # Copy built site to root
            cp -r _site/* .
            rm -rf _site

            # CNAME file
            echo "fablab.thomaslemaitre.fr" > CNAME

            # Add and commit changes
            git add .
            git commit -m "Deploy site" || exit 0
            git push origin HEAD:gh-pages --force
